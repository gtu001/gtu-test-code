-----------------------------------------------------------------------------------


啟動container

winpty docker run --privileged  -p 5432:5432 -td  <image_id>  bash


-----------------------------------------------------------------------------------

安裝

    $ sudo apt-get update
    $ sudo apt-get install postgresql postgresql-contrib


-----------------------------------------------------------------------------------
    
    
啟動服務
    
    $ sudo service postgresql start
        
        
-----------------------------------------------------------------------------------


確認cluster是否有在跑

    $ pg_lsclusters
    
        Ver Cluster Port Status Owner    Data directory              Log file
        10  main    5432 online postgres /var/lib/postgresql/10/main /var/log/postgresql/postgresql-10-main.log


-----------------------------------------------------------------------------------

建立cluster 
	
	$ sudo locale-gen zh_TW.UTF-8
	$  pg_createcluster <version> <cluster_name>  --locale=zh_TW.UTF-8 -e UTF8 --start --start-conf=manual
	 
	 Ex : pg_createcluster 10 main  --locale=zh_TW.UTF-8 -e UTF8 --start --start-conf=manual

	$ sudo -u postgres psql
	=> show LC_COLLATE;

-----------------------------------------------------------------------------------

停掉cluster

	$ sudo pg_dropcluster --stop <version> <cluster_name>


-----------------------------------------------------------------------------------

控制cluster 

	$ pg_ctlcluster <cluster_version> <cluster-name> <action>
	
	Ex : pg_ctlcluster 10   main    restart
	
	用上上指令可看 參數內容
	Ps:
	設定檔位置 /etc/postgresql/<cluster-version>/<cluster-name>/start.conf
	Ps:
	可用Action : (start|stop|restart|reload|status|promote)
	
-----------------------------------------------------------------------------------

停掉cluster
	
	$ sudo -u postgres  pg_ctlcluster 10 main stop
	or
	$ sudo  systemctl  stop  postgresql@10-main

-----------------------------------------------------------------------------------

修改 cluster port
	
	$vim  /etc/postgresql/<cluster-version>/<cluster-name>/postgresql.conf
	
	--> 加入 
		port=5432 
		重開即可 Ps:參考 控制cluster

	Ex : /etc/postgresql/10/main/postgresql.conf


-----------------------------------------------------------------------------------


登入 postgres shell

	$ su postgres
	$ psql
	
	postgres=# 執行底下
		$ CREATE SCHEMA test;
		
		//option
		$ CREATE USER test_user PASSWORD '1234';
		$ CREATE ROLE test_user WITH LOGIN PASSWORD '1234' VALID UNTIL '2099-01-01' ;
		
		$ GRANT ALL ON SCHEMA test TO test_user;
		$ GRANT ALL ON ALL TABLES IN SCHEMA test TO test_user;
		
		$ create database TEST with owner test_user encoding utf8 ;
		
		$ \q  <--disconnect
		

-----------------------------------------------------------------------------------
建立新postres於linux的user (透過postgres建立linux user)

	1.於user postgres底下
		$ createuser --interactive
	2.於其他user底下
		$ sudo -u postgres createuser --interactive
		
	Ps: 建立後可以切換至該user , 用以登入 psql shell
	

-----------------------------------------------------------------------------------
顯示連線資訊
	postgres=# 執行底下
		$ \conninfo
		

-----------------------------------------------------------------------------------
顯示資料庫關聯
	postgres=# 執行底下
		$ \d
		$ \dt
		

-----------------------------------------------------------------------------------
顯示資料庫
	postgres=# 執行底下
		$ \l


-----------------------------------------------------------------------------------

連線測試

	$ psql -h 127.0.0.1 -p 5432 -U test_user -d test
		Ps : h host
			 p port
			 U user
			 d database
			 

-----------------------------------------------------------------------------------


root@df74b0cfaf9b:~# netstat  -nlp
↓↓↓↓↓↓　有通的網路應該長這樣  ↓↓↓↓↓↓

Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:5432            0.0.0.0:*               LISTEN      156/postgres
tcp6       0      0 :::5432                 :::*                    LISTEN      156/postgres
Active UNIX domain sockets (only servers)
Proto RefCnt Flags       Type       State         I-Node   PID/Program name     Path
unix  2      [ ACC ]     STREAM     LISTENING     42459    156/postgres         /var/run/postgresql/.s.PGSQL.5432

↑↑↑↑↑↑　有通的網路應該長這樣  ↑↑↑↑↑↑

解法 :
	$ vim /var/lib/postgresql/10/main/postgresql.auto.conf
	or
	$ vim /etc/postgresql/10/main/postgresql.conf
	把
	listen_addresses = 'localhost'
	改成
	listen_addresses = '*'

-----------------------------------------------------------------------------------
錯誤
FATAL: no pg_hba.conf entry for host "192.168.99.1", user "test_user", database "test", SSL off

解法 :
	$ su postgres
	$ psql
	postgres=# 執行底下
		CREATE USER <user_name> SUPERUSER;
		CREATE DATABASE <database_name> WITH OWNER <user_name>;
		\q
	$ vim /etc/postgresql/10/main/pg_hba.conf
	加入以下
		local all <user_name> trust
		host all <user_name> 0.0.0.0/0 trust
		host all <user_name> ::/0 trust

-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------